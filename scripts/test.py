from datetime import datetime, timedelta
from dateutil import tz
import os
import json
import itertools

import boto3
from botocore.client import Config
import airflow
from airflow.operators.python_operator import PythonOperator
import gtfs_tripify as gt
import t4


AWS_BUCKET_NAME = 'quilt-transit-archive'
FEEDMAP = {
    1:  ['1', '2', '3', '4', '5', '6', 'GS'],
    2:  ['L'],
    11: ['SI'],
    16: ['N', 'Q', 'R', 'W'],
    21: ['B', 'D', 'F', 'M'],
    26: ['A', 'C', 'E', 'H', 'FS'],
    31: ['G'],
    36: ['J', 'Z'],
    51: ['7']
}
ROUTE_IDS = itertools.chain(*FEEDMAP.values())
S3_TIMEOUT = 60
rollup_start_time = datetime(2019, 5, 9).strftime("%Y%m%d%H")

s3_config = Config(connect_timeout=S3_TIMEOUT, read_timeout=S3_TIMEOUT)
aws_client = boto3.client('s3', config=s3_config)

params = {'feed_id': 1, 'ts_f_strings': ['20190509T0659Z', '20190509T0700Z', '20190509T0701Z', '20190509T0702Z', '20190509T0703Z', '20190509T0704Z', '20190509T0705Z', '20190509T0706Z', '20190509T0707Z', '20190509T0708Z', '20190509T0709Z', '20190509T0710Z', '20190509T0711Z', '20190509T0712Z', '20190509T0713Z', '20190509T0714Z', '20190509T0715Z', '20190509T0716Z', '20190509T0717Z', '20190509T0718Z', '20190509T0719Z', '20190509T0720Z', '20190509T0721Z', '20190509T0722Z', '20190509T0723Z', '20190509T0724Z', '20190509T0725Z', '20190509T0726Z', '20190509T0727Z', '20190509T0728Z', '20190509T0729Z', '20190509T0730Z', '20190509T0731Z', '20190509T0732Z', '20190509T0733Z', '20190509T0734Z', '20190509T0735Z', '20190509T0736Z', '20190509T0737Z', '20190509T0738Z', '20190509T0739Z', '20190509T0740Z', '20190509T0741Z', '20190509T0742Z', '20190509T0743Z', '20190509T0744Z', '20190509T0745Z', '20190509T0746Z', '20190509T0747Z', '20190509T0748Z', '20190509T0749Z', '20190509T0750Z', '20190509T0751Z', '20190509T0752Z', '20190509T0753Z', '20190509T0754Z', '20190509T0755Z', '20190509T0756Z', '20190509T0757Z', '20190509T0758Z', '20190509T0759Z', '20190509T0800Z', '20190509T0801Z', '20190509T0802Z', '20190509T0803Z', '20190509T0804Z', '20190509T0805Z', '20190509T0806Z', '20190509T0807Z', '20190509T0808Z', '20190509T0809Z', '20190509T0810Z', '20190509T0811Z', '20190509T0812Z', '20190509T0813Z', '20190509T0814Z', '20190509T0815Z', '20190509T0816Z', '20190509T0817Z', '20190509T0818Z', '20190509T0819Z', '20190509T0820Z', '20190509T0821Z', '20190509T0822Z', '20190509T0823Z', '20190509T0824Z', '20190509T0825Z', '20190509T0826Z', '20190509T0827Z', '20190509T0828Z', '20190509T0829Z', '20190509T0830Z', '20190509T0831Z', '20190509T0832Z', '20190509T0833Z', '20190509T0834Z', '20190509T0835Z', '20190509T0836Z', '20190509T0837Z', '20190509T0838Z', '20190509T0839Z', '20190509T0840Z', '20190509T0841Z', '20190509T0842Z', '20190509T0843Z', '20190509T0844Z', '20190509T0845Z', '20190509T0846Z', '20190509T0847Z', '20190509T0848Z', '20190509T0849Z', '20190509T0850Z', '20190509T0851Z', '20190509T0852Z', '20190509T0853Z', '20190509T0854Z', '20190509T0855Z', '20190509T0856Z', '20190509T0857Z', '20190509T0858Z', '20190509T0859Z']}

# params = {'feed_id': 51, 'ts_f_strings': ['20190509T0659Z', '20190509T0700Z', '20190509T0701Z', '20190509T0702Z', '20190509T0703Z', '20190509T0704Z', '20190509T0705Z', '20190509T0706Z', '20190509T0707Z', '20190509T0708Z', '20190509T0709Z', '20190509T0710Z', '20190509T0711Z', '20190509T0712Z', '20190509T0713Z', '20190509T0714Z', '20190509T0715Z', '20190509T0716Z', '20190509T0717Z', '20190509T0718Z', '20190509T0719Z', '20190509T0720Z', '20190509T0721Z', '20190509T0722Z', '20190509T0723Z', '20190509T0724Z', '20190509T0725Z', '20190509T0726Z', '20190509T0727Z', '20190509T0728Z', '20190509T0729Z', '20190509T0730Z', '20190509T0731Z', '20190509T0732Z', '20190509T0733Z', '20190509T0734Z', '20190509T0735Z', '20190509T0736Z', '20190509T0737Z', '20190509T0738Z', '20190509T0739Z', '20190509T0740Z', '20190509T0741Z', '20190509T0742Z', '20190509T0743Z', '20190509T0744Z', '20190509T0745Z', '20190509T0746Z', '20190509T0747Z', '20190509T0748Z', '20190509T0749Z', '20190509T0750Z', '20190509T0751Z', '20190509T0752Z', '20190509T0753Z', '20190509T0754Z', '20190509T0755Z', '20190509T0756Z', '20190509T0757Z', '20190509T0758Z', '20190509T0759Z', '20190509T0800Z', '20190509T0801Z', '20190509T0802Z', '20190509T0803Z', '20190509T0804Z', '20190509T0805Z', '20190509T0806Z', '20190509T0807Z', '20190509T0808Z', '20190509T0809Z', '20190509T0810Z', '20190509T0811Z', '20190509T0812Z', '20190509T0813Z', '20190509T0814Z', '20190509T0815Z', '20190509T0816Z', '20190509T0817Z', '20190509T0818Z', '20190509T0819Z', '20190509T0820Z', '20190509T0821Z', '20190509T0822Z', '20190509T0823Z', '20190509T0824Z', '20190509T0825Z', '20190509T0826Z', '20190509T0827Z', '20190509T0828Z', '20190509T0829Z', '20190509T0830Z', '20190509T0831Z', '20190509T0832Z', '20190509T0833Z', '20190509T0834Z', '20190509T0835Z', '20190509T0836Z', '20190509T0837Z', '20190509T0838Z', '20190509T0839Z', '20190509T0840Z', '20190509T0841Z', '20190509T0842Z', '20190509T0843Z', '20190509T0844Z', '20190509T0845Z', '20190509T0846Z', '20190509T0847Z', '20190509T0848Z', '20190509T0849Z', '20190509T0850Z', '20190509T0851Z', '20190509T0852Z', '20190509T0853Z', '20190509T0854Z', '20190509T0855Z', '20190509T0856Z', '20190509T0857Z', '20190509T0858Z', '20190509T0859Z', '20190509T0900Z', '20190509T0901Z', '20190509T0902Z', '20190509T0903Z', '20190509T0904Z', '20190509T0905Z', '20190509T0906Z', '20190509T0907Z', '20190509T0908Z', '20190509T0909Z', '20190509T0910Z', '20190509T0911Z', '20190509T0912Z', '20190509T0913Z', '20190509T0914Z', '20190509T0915Z', '20190509T0916Z', '20190509T0917Z', '20190509T0918Z', '20190509T0919Z', '20190509T0920Z', '20190509T0921Z', '20190509T0922Z', '20190509T0923Z', '20190509T0924Z', '20190509T0925Z', '20190509T0926Z', '20190509T0927Z', '20190509T0928Z', '20190509T0929Z', '20190509T0930Z', '20190509T0931Z', '20190509T0932Z', '20190509T0933Z', '20190509T0934Z', '20190509T0935Z', '20190509T0936Z', '20190509T0937Z', '20190509T0938Z', '20190509T0939Z', '20190509T0940Z', '20190509T0941Z', '20190509T0942Z', '20190509T0943Z', '20190509T0944Z', '20190509T0945Z', '20190509T0946Z', '20190509T0947Z', '20190509T0948Z', '20190509T0949Z', '20190509T0950Z', '20190509T0951Z', '20190509T0952Z', '20190509T0953Z', '20190509T0954Z', '20190509T0955Z', '20190509T0956Z', '20190509T0957Z', '20190509T0958Z', '20190509T0959Z', '20190509T1000Z', '20190509T1001Z', '20190509T1002Z', '20190509T1003Z', '20190509T1004Z', '20190509T1005Z', '20190509T1006Z', '20190509T1007Z', '20190509T1008Z', '20190509T1009Z', '20190509T1010Z', '20190509T1011Z', '20190509T1012Z', '20190509T1013Z', '20190509T1014Z', '20190509T1015Z', '20190509T1016Z', '20190509T1017Z', '20190509T1018Z', '20190509T1019Z', '20190509T1020Z', '20190509T1021Z', '20190509T1022Z', '20190509T1023Z', '20190509T1024Z', '20190509T1025Z', '20190509T1026Z', '20190509T1027Z', '20190509T1028Z', '20190509T1029Z', '20190509T1030Z', '20190509T1031Z', '20190509T1032Z', '20190509T1033Z', '20190509T1034Z', '20190509T1035Z', '20190509T1036Z', '20190509T1037Z', '20190509T1038Z', '20190509T1039Z', '20190509T1040Z', '20190509T1041Z', '20190509T1042Z', '20190509T1043Z', '20190509T1044Z', '20190509T1045Z', '20190509T1046Z', '20190509T1047Z', '20190509T1048Z', '20190509T1049Z', '20190509T1050Z', '20190509T1051Z', '20190509T1052Z', '20190509T1053Z', '20190509T1054Z', '20190509T1055Z', '20190509T1056Z', '20190509T1057Z', '20190509T1058Z', '20190509T1059Z', '20190509T1100Z', '20190509T1101Z', '20190509T1102Z', '20190509T1103Z', '20190509T1104Z', '20190509T1105Z', '20190509T1106Z', '20190509T1107Z', '20190509T1108Z', '20190509T1109Z', '20190509T1110Z', '20190509T1111Z', '20190509T1112Z', '20190509T1113Z', '20190509T1114Z', '20190509T1115Z', '20190509T1116Z', '20190509T1117Z', '20190509T1118Z', '20190509T1119Z', '20190509T1120Z', '20190509T1121Z', '20190509T1122Z', '20190509T1123Z', '20190509T1124Z', '20190509T1125Z', '20190509T1126Z', '20190509T1127Z', '20190509T1128Z', '20190509T1129Z', '20190509T1130Z', '20190509T1131Z', '20190509T1132Z', '20190509T1133Z', '20190509T1134Z', '20190509T1135Z', '20190509T1136Z', '20190509T1137Z', '20190509T1138Z', '20190509T1139Z', '20190509T1140Z', '20190509T1141Z', '20190509T1142Z', '20190509T1143Z', '20190509T1144Z', '20190509T1145Z', '20190509T1146Z', '20190509T1147Z', '20190509T1148Z', '20190509T1149Z', '20190509T1150Z', '20190509T1151Z', '20190509T1152Z', '20190509T1153Z', '20190509T1154Z', '20190509T1155Z', '20190509T1156Z', '20190509T1157Z', '20190509T1158Z', '20190509T1159Z', '20190509T1200Z', '20190509T1201Z', '20190509T1202Z', '20190509T1203Z', '20190509T1204Z', '20190509T1205Z', '20190509T1206Z', '20190509T1207Z', '20190509T1208Z', '20190509T1209Z', '20190509T1210Z', '20190509T1211Z', '20190509T1212Z', '20190509T1213Z', '20190509T1214Z', '20190509T1215Z', '20190509T1216Z', '20190509T1217Z', '20190509T1218Z', '20190509T1219Z', '20190509T1220Z', '20190509T1221Z', '20190509T1222Z', '20190509T1223Z', '20190509T1224Z', '20190509T1225Z', '20190509T1226Z', '20190509T1227Z', '20190509T1228Z', '20190509T1229Z', '20190509T1230Z', '20190509T1231Z', '20190509T1232Z', '20190509T1233Z', '20190509T1234Z', '20190509T1235Z', '20190509T1236Z', '20190509T1237Z', '20190509T1238Z', '20190509T1239Z', '20190509T1240Z', '20190509T1241Z', '20190509T1242Z', '20190509T1243Z', '20190509T1244Z', '20190509T1245Z', '20190509T1246Z', '20190509T1247Z', '20190509T1248Z', '20190509T1249Z', '20190509T1250Z', '20190509T1251Z', '20190509T1252Z', '20190509T1253Z', '20190509T1254Z', '20190509T1255Z', '20190509T1256Z', '20190509T1257Z', '20190509T1258Z', '20190509T1259Z', '20190509T1300Z', '20190509T1301Z', '20190509T1302Z', '20190509T1303Z', '20190509T1304Z', '20190509T1305Z', '20190509T1306Z', '20190509T1307Z', '20190509T1308Z', '20190509T1309Z', '20190509T1310Z', '20190509T1311Z', '20190509T1312Z', '20190509T1313Z', '20190509T1314Z', '20190509T1315Z', '20190509T1316Z', '20190509T1317Z', '20190509T1318Z', '20190509T1319Z', '20190509T1320Z', '20190509T1321Z', '20190509T1322Z', '20190509T1323Z', '20190509T1324Z', '20190509T1325Z', '20190509T1326Z', '20190509T1327Z', '20190509T1328Z', '20190509T1329Z', '20190509T1330Z', '20190509T1331Z', '20190509T1332Z', '20190509T1333Z', '20190509T1334Z', '20190509T1335Z', '20190509T1336Z', '20190509T1337Z', '20190509T1338Z', '20190509T1339Z', '20190509T1340Z', '20190509T1341Z', '20190509T1342Z', '20190509T1343Z', '20190509T1344Z', '20190509T1345Z', '20190509T1346Z', '20190509T1347Z', '20190509T1348Z', '20190509T1349Z', '20190509T1350Z', '20190509T1351Z', '20190509T1352Z', '20190509T1353Z', '20190509T1354Z', '20190509T1355Z', '20190509T1356Z', '20190509T1357Z', '20190509T1358Z', '20190509T1359Z', '20190509T1400Z', '20190509T1401Z', '20190509T1402Z', '20190509T1403Z', '20190509T1404Z', '20190509T1405Z', '20190509T1406Z', '20190509T1407Z', '20190509T1408Z', '20190509T1409Z', '20190509T1410Z', '20190509T1411Z', '20190509T1412Z', '20190509T1413Z', '20190509T1414Z', '20190509T1415Z', '20190509T1416Z', '20190509T1417Z', '20190509T1418Z', '20190509T1419Z', '20190509T1420Z', '20190509T1421Z', '20190509T1422Z', '20190509T1423Z', '20190509T1424Z', '20190509T1425Z', '20190509T1426Z', '20190509T1427Z', '20190509T1428Z', '20190509T1429Z', '20190509T1430Z', '20190509T1431Z', '20190509T1432Z', '20190509T1433Z', '20190509T1434Z', '20190509T1435Z', '20190509T1436Z', '20190509T1437Z', '20190509T1438Z', '20190509T1439Z', '20190509T1440Z', '20190509T1441Z', '20190509T1442Z', '20190509T1443Z', '20190509T1444Z', '20190509T1445Z', '20190509T1446Z', '20190509T1447Z', '20190509T1448Z', '20190509T1449Z', '20190509T1450Z', '20190509T1451Z', '20190509T1452Z', '20190509T1453Z', '20190509T1454Z', '20190509T1455Z', '20190509T1456Z', '20190509T1457Z', '20190509T1458Z', '20190509T1459Z', '20190509T1500Z', '20190509T1501Z', '20190509T1502Z', '20190509T1503Z', '20190509T1504Z', '20190509T1505Z', '20190509T1506Z', '20190509T1507Z', '20190509T1508Z', '20190509T1509Z', '20190509T1510Z', '20190509T1511Z', '20190509T1512Z', '20190509T1513Z', '20190509T1514Z', '20190509T1515Z', '20190509T1516Z', '20190509T1517Z', '20190509T1518Z', '20190509T1519Z', '20190509T1520Z', '20190509T1521Z', '20190509T1522Z', '20190509T1523Z', '20190509T1524Z', '20190509T1525Z', '20190509T1526Z', '20190509T1527Z', '20190509T1528Z', '20190509T1529Z', '20190509T1530Z', '20190509T1531Z', '20190509T1532Z', '20190509T1533Z', '20190509T1534Z', '20190509T1535Z', '20190509T1536Z', '20190509T1537Z', '20190509T1538Z', '20190509T1539Z', '20190509T1540Z', '20190509T1541Z', '20190509T1542Z', '20190509T1543Z', '20190509T1544Z', '20190509T1545Z', '20190509T1546Z', '20190509T1547Z', '20190509T1548Z', '20190509T1549Z', '20190509T1550Z', '20190509T1551Z', '20190509T1552Z', '20190509T1553Z', '20190509T1554Z', '20190509T1555Z', '20190509T1556Z', '20190509T1557Z', '20190509T1558Z', '20190509T1559Z', '20190509T1600Z', '20190509T1601Z', '20190509T1602Z', '20190509T1603Z', '20190509T1604Z', '20190509T1605Z', '20190509T1606Z', '20190509T1607Z', '20190509T1608Z', '20190509T1609Z', '20190509T1610Z', '20190509T1611Z', '20190509T1612Z', '20190509T1613Z', '20190509T1614Z', '20190509T1615Z', '20190509T1616Z', '20190509T1617Z', '20190509T1618Z', '20190509T1619Z', '20190509T1620Z', '20190509T1621Z', '20190509T1622Z', '20190509T1623Z', '20190509T1624Z', '20190509T1625Z', '20190509T1626Z', '20190509T1627Z', '20190509T1628Z', '20190509T1629Z', '20190509T1630Z', '20190509T1631Z', '20190509T1632Z', '20190509T1633Z', '20190509T1634Z', '20190509T1635Z', '20190509T1636Z', '20190509T1637Z', '20190509T1638Z', '20190509T1639Z', '20190509T1640Z', '20190509T1641Z', '20190509T1642Z', '20190509T1643Z', '20190509T1644Z', '20190509T1645Z', '20190509T1646Z', '20190509T1647Z', '20190509T1648Z', '20190509T1649Z', '20190509T1650Z', '20190509T1651Z', '20190509T1652Z', '20190509T1653Z', '20190509T1654Z', '20190509T1655Z', '20190509T1656Z', '20190509T1657Z', '20190509T1658Z', '20190509T1659Z', '20190509T1700Z', '20190509T1701Z', '20190509T1702Z', '20190509T1703Z', '20190509T1704Z', '20190509T1705Z', '20190509T1706Z', '20190509T1707Z', '20190509T1708Z', '20190509T1709Z', '20190509T1710Z', '20190509T1711Z', '20190509T1712Z', '20190509T1713Z', '20190509T1714Z', '20190509T1715Z', '20190509T1716Z', '20190509T1717Z', '20190509T1718Z', '20190509T1719Z', '20190509T1720Z', '20190509T1721Z', '20190509T1722Z', '20190509T1723Z', '20190509T1724Z', '20190509T1725Z', '20190509T1726Z', '20190509T1727Z', '20190509T1728Z', '20190509T1729Z', '20190509T1730Z', '20190509T1731Z', '20190509T1732Z', '20190509T1733Z', '20190509T1734Z', '20190509T1735Z', '20190509T1736Z', '20190509T1737Z', '20190509T1738Z', '20190509T1739Z', '20190509T1740Z', '20190509T1741Z', '20190509T1742Z', '20190509T1743Z', '20190509T1744Z', '20190509T1745Z', '20190509T1746Z', '20190509T1747Z', '20190509T1748Z', '20190509T1749Z', '20190509T1750Z', '20190509T1751Z', '20190509T1752Z', '20190509T1753Z', '20190509T1754Z', '20190509T1755Z', '20190509T1756Z', '20190509T1757Z', '20190509T1758Z', '20190509T1759Z', '20190509T1800Z', '20190509T1801Z', '20190509T1802Z', '20190509T1803Z', '20190509T1804Z', '20190509T1805Z', '20190509T1806Z', '20190509T1807Z', '20190509T1808Z', '20190509T1809Z', '20190509T1810Z', '20190509T1811Z', '20190509T1812Z', '20190509T1813Z', '20190509T1814Z', '20190509T1815Z', '20190509T1816Z', '20190509T1817Z', '20190509T1818Z', '20190509T1819Z', '20190509T1820Z', '20190509T1821Z', '20190509T1822Z', '20190509T1823Z', '20190509T1824Z', '20190509T1825Z', '20190509T1826Z', '20190509T1827Z', '20190509T1828Z', '20190509T1829Z', '20190509T1830Z', '20190509T1831Z', '20190509T1832Z', '20190509T1833Z', '20190509T1834Z', '20190509T1835Z', '20190509T1836Z', '20190509T1837Z', '20190509T1838Z', '20190509T1839Z', '20190509T1840Z', '20190509T1841Z', '20190509T1842Z', '20190509T1843Z', '20190509T1844Z', '20190509T1845Z', '20190509T1846Z', '20190509T1847Z', '20190509T1848Z', '20190509T1849Z', '20190509T1850Z', '20190509T1851Z', '20190509T1852Z', '20190509T1853Z', '20190509T1854Z', '20190509T1855Z', '20190509T1856Z', '20190509T1857Z', '20190509T1858Z', '20190509T1859Z', '20190509T1900Z', '20190509T1901Z', '20190509T1902Z', '20190509T1903Z', '20190509T1904Z', '20190509T1905Z', '20190509T1906Z', '20190509T1907Z', '20190509T1908Z', '20190509T1909Z', '20190509T1910Z', '20190509T1911Z', '20190509T1912Z', '20190509T1913Z', '20190509T1914Z', '20190509T1915Z', '20190509T1916Z', '20190509T1917Z', '20190509T1918Z', '20190509T1919Z', '20190509T1920Z', '20190509T1921Z', '20190509T1922Z', '20190509T1923Z', '20190509T1924Z', '20190509T1925Z', '20190509T1926Z', '20190509T1927Z', '20190509T1928Z', '20190509T1929Z', '20190509T1930Z', '20190509T1931Z', '20190509T1932Z', '20190509T1933Z', '20190509T1934Z', '20190509T1935Z', '20190509T1936Z', '20190509T1937Z', '20190509T1938Z', '20190509T1939Z', '20190509T1940Z', '20190509T1941Z', '20190509T1942Z', '20190509T1943Z', '20190509T1944Z', '20190509T1945Z', '20190509T1946Z', '20190509T1947Z', '20190509T1948Z', '20190509T1949Z', '20190509T1950Z', '20190509T1951Z', '20190509T1952Z', '20190509T1953Z', '20190509T1954Z', '20190509T1955Z', '20190509T1956Z', '20190509T1957Z', '20190509T1958Z', '20190509T1959Z', '20190509T2000Z', '20190509T2001Z', '20190509T2002Z', '20190509T2003Z', '20190509T2004Z', '20190509T2005Z', '20190509T2006Z', '20190509T2007Z', '20190509T2008Z', '20190509T2009Z', '20190509T2010Z', '20190509T2011Z', '20190509T2012Z', '20190509T2013Z', '20190509T2014Z', '20190509T2015Z', '20190509T2016Z', '20190509T2017Z', '20190509T2018Z', '20190509T2019Z', '20190509T2020Z', '20190509T2021Z', '20190509T2022Z', '20190509T2023Z', '20190509T2024Z', '20190509T2025Z', '20190509T2026Z', '20190509T2027Z', '20190509T2028Z', '20190509T2029Z', '20190509T2030Z', '20190509T2031Z', '20190509T2032Z', '20190509T2033Z', '20190509T2034Z', '20190509T2035Z', '20190509T2036Z', '20190509T2037Z', '20190509T2038Z', '20190509T2039Z', '20190509T2040Z', '20190509T2041Z', '20190509T2042Z', '20190509T2043Z', '20190509T2044Z', '20190509T2045Z', '20190509T2046Z', '20190509T2047Z', '20190509T2048Z', '20190509T2049Z', '20190509T2050Z', '20190509T2051Z', '20190509T2052Z', '20190509T2053Z', '20190509T2054Z', '20190509T2055Z', '20190509T2056Z', '20190509T2057Z', '20190509T2058Z', '20190509T2059Z', '20190509T2100Z', '20190509T2101Z', '20190509T2102Z', '20190509T2103Z', '20190509T2104Z', '20190509T2105Z', '20190509T2106Z', '20190509T2107Z', '20190509T2108Z', '20190509T2109Z', '20190509T2110Z', '20190509T2111Z', '20190509T2112Z', '20190509T2113Z', '20190509T2114Z', '20190509T2115Z', '20190509T2116Z', '20190509T2117Z', '20190509T2118Z', '20190509T2119Z', '20190509T2120Z', '20190509T2121Z', '20190509T2122Z', '20190509T2123Z', '20190509T2124Z', '20190509T2125Z', '20190509T2126Z', '20190509T2127Z', '20190509T2128Z', '20190509T2129Z', '20190509T2130Z', '20190509T2131Z', '20190509T2132Z', '20190509T2133Z', '20190509T2134Z', '20190509T2135Z', '20190509T2136Z', '20190509T2137Z', '20190509T2138Z', '20190509T2139Z', '20190509T2140Z', '20190509T2141Z', '20190509T2142Z', '20190509T2143Z', '20190509T2144Z', '20190509T2145Z', '20190509T2146Z', '20190509T2147Z', '20190509T2148Z', '20190509T2149Z', '20190509T2150Z', '20190509T2151Z', '20190509T2152Z', '20190509T2153Z', '20190509T2154Z', '20190509T2155Z', '20190509T2156Z', '20190509T2157Z', '20190509T2158Z', '20190509T2159Z', '20190509T2200Z', '20190509T2201Z', '20190509T2202Z', '20190509T2203Z', '20190509T2204Z', '20190509T2205Z', '20190509T2206Z', '20190509T2207Z', '20190509T2208Z', '20190509T2209Z', '20190509T2210Z', '20190509T2211Z', '20190509T2212Z', '20190509T2213Z', '20190509T2214Z', '20190509T2215Z', '20190509T2216Z', '20190509T2217Z', '20190509T2218Z', '20190509T2219Z', '20190509T2220Z', '20190509T2221Z', '20190509T2222Z', '20190509T2223Z', '20190509T2224Z', '20190509T2225Z', '20190509T2226Z', '20190509T2227Z', '20190509T2228Z', '20190509T2229Z', '20190509T2230Z', '20190509T2231Z', '20190509T2232Z', '20190509T2233Z', '20190509T2234Z', '20190509T2235Z', '20190509T2236Z', '20190509T2237Z', '20190509T2238Z', '20190509T2239Z', '20190509T2240Z', '20190509T2241Z', '20190509T2242Z', '20190509T2243Z', '20190509T2244Z', '20190509T2245Z', '20190509T2246Z', '20190509T2247Z', '20190509T2248Z', '20190509T2249Z', '20190509T2250Z', '20190509T2251Z', '20190509T2252Z', '20190509T2253Z', '20190509T2254Z', '20190509T2255Z', '20190509T2256Z', '20190509T2257Z', '20190509T2258Z', '20190509T2259Z', '20190509T2300Z', '20190509T2301Z', '20190509T2302Z', '20190509T2303Z', '20190509T2304Z', '20190509T2305Z', '20190509T2306Z', '20190509T2307Z', '20190509T2308Z', '20190509T2309Z', '20190509T2310Z', '20190509T2311Z', '20190509T2312Z', '20190509T2313Z', '20190509T2314Z', '20190509T2315Z', '20190509T2316Z', '20190509T2317Z', '20190509T2318Z', '20190509T2319Z', '20190509T2320Z', '20190509T2321Z', '20190509T2322Z', '20190509T2323Z', '20190509T2324Z', '20190509T2325Z', '20190509T2326Z', '20190509T2327Z', '20190509T2328Z', '20190509T2329Z', '20190509T2330Z', '20190509T2331Z', '20190509T2332Z', '20190509T2333Z', '20190509T2334Z', '20190509T2335Z', '20190509T2336Z', '20190509T2337Z', '20190509T2338Z', '20190509T2339Z', '20190509T2340Z', '20190509T2341Z', '20190509T2342Z', '20190509T2343Z', '20190509T2344Z', '20190509T2345Z', '20190509T2346Z', '20190509T2347Z', '20190509T2348Z', '20190509T2349Z', '20190509T2350Z', '20190509T2351Z', '20190509T2352Z', '20190509T2353Z', '20190509T2354Z', '20190509T2355Z', '20190509T2356Z', '20190509T2357Z', '20190509T2358Z', '20190509T2359Z', '20190510T0000Z', '20190510T0001Z', '20190510T0002Z', '20190510T0003Z', '20190510T0004Z', '20190510T0005Z', '20190510T0006Z', '20190510T0007Z', '20190510T0008Z', '20190510T0009Z', '20190510T0010Z', '20190510T0011Z', '20190510T0012Z', '20190510T0013Z', '20190510T0014Z', '20190510T0015Z', '20190510T0016Z', '20190510T0017Z', '20190510T0018Z', '20190510T0019Z', '20190510T0020Z', '20190510T0021Z', '20190510T0022Z', '20190510T0023Z', '20190510T0024Z', '20190510T0025Z', '20190510T0026Z', '20190510T0027Z', '20190510T0028Z', '20190510T0029Z', '20190510T0030Z', '20190510T0031Z', '20190510T0032Z', '20190510T0033Z', '20190510T0034Z', '20190510T0035Z', '20190510T0036Z', '20190510T0037Z', '20190510T0038Z', '20190510T0039Z', '20190510T0040Z', '20190510T0041Z', '20190510T0042Z', '20190510T0043Z', '20190510T0044Z', '20190510T0045Z', '20190510T0046Z', '20190510T0047Z', '20190510T0048Z', '20190510T0049Z', '20190510T0050Z', '20190510T0051Z', '20190510T0052Z', '20190510T0053Z', '20190510T0054Z', '20190510T0055Z', '20190510T0056Z', '20190510T0057Z', '20190510T0058Z', '20190510T0059Z', '20190510T0100Z', '20190510T0101Z', '20190510T0102Z', '20190510T0103Z', '20190510T0104Z', '20190510T0105Z', '20190510T0106Z', '20190510T0107Z', '20190510T0108Z', '20190510T0109Z', '20190510T0110Z', '20190510T0111Z', '20190510T0112Z', '20190510T0113Z', '20190510T0114Z', '20190510T0115Z', '20190510T0116Z', '20190510T0117Z', '20190510T0118Z', '20190510T0119Z', '20190510T0120Z', '20190510T0121Z', '20190510T0122Z', '20190510T0123Z', '20190510T0124Z', '20190510T0125Z', '20190510T0126Z', '20190510T0127Z', '20190510T0128Z', '20190510T0129Z', '20190510T0130Z', '20190510T0131Z', '20190510T0132Z', '20190510T0133Z', '20190510T0134Z', '20190510T0135Z', '20190510T0136Z', '20190510T0137Z', '20190510T0138Z', '20190510T0139Z', '20190510T0140Z', '20190510T0141Z', '20190510T0142Z', '20190510T0143Z', '20190510T0144Z', '20190510T0145Z', '20190510T0146Z', '20190510T0147Z', '20190510T0148Z', '20190510T0149Z', '20190510T0150Z', '20190510T0151Z', '20190510T0152Z', '20190510T0153Z', '20190510T0154Z', '20190510T0155Z', '20190510T0156Z', '20190510T0157Z', '20190510T0158Z', '20190510T0159Z', '20190510T0200Z', '20190510T0201Z', '20190510T0202Z', '20190510T0203Z', '20190510T0204Z', '20190510T0205Z', '20190510T0206Z', '20190510T0207Z', '20190510T0208Z', '20190510T0209Z', '20190510T0210Z', '20190510T0211Z', '20190510T0212Z', '20190510T0213Z', '20190510T0214Z', '20190510T0215Z', '20190510T0216Z', '20190510T0217Z', '20190510T0218Z', '20190510T0219Z', '20190510T0220Z', '20190510T0221Z', '20190510T0222Z', '20190510T0223Z', '20190510T0224Z', '20190510T0225Z', '20190510T0226Z', '20190510T0227Z', '20190510T0228Z', '20190510T0229Z', '20190510T0230Z', '20190510T0231Z', '20190510T0232Z', '20190510T0233Z', '20190510T0234Z', '20190510T0235Z', '20190510T0236Z', '20190510T0237Z', '20190510T0238Z', '20190510T0239Z', '20190510T0240Z', '20190510T0241Z', '20190510T0242Z', '20190510T0243Z', '20190510T0244Z', '20190510T0245Z', '20190510T0246Z', '20190510T0247Z', '20190510T0248Z', '20190510T0249Z', '20190510T0250Z', '20190510T0251Z', '20190510T0252Z', '20190510T0253Z', '20190510T0254Z', '20190510T0255Z', '20190510T0256Z', '20190510T0257Z', '20190510T0258Z', '20190510T0259Z', '20190510T0300Z', '20190510T0301Z', '20190510T0302Z', '20190510T0303Z', '20190510T0304Z', '20190510T0305Z', '20190510T0306Z', '20190510T0307Z', '20190510T0308Z', '20190510T0309Z', '20190510T0310Z', '20190510T0311Z', '20190510T0312Z', '20190510T0313Z', '20190510T0314Z', '20190510T0315Z', '20190510T0316Z', '20190510T0317Z', '20190510T0318Z', '20190510T0319Z', '20190510T0320Z', '20190510T0321Z', '20190510T0322Z', '20190510T0323Z', '20190510T0324Z', '20190510T0325Z', '20190510T0326Z', '20190510T0327Z', '20190510T0328Z', '20190510T0329Z', '20190510T0330Z', '20190510T0331Z', '20190510T0332Z', '20190510T0333Z', '20190510T0334Z', '20190510T0335Z', '20190510T0336Z', '20190510T0337Z', '20190510T0338Z', '20190510T0339Z', '20190510T0340Z', '20190510T0341Z', '20190510T0342Z', '20190510T0343Z', '20190510T0344Z', '20190510T0345Z', '20190510T0346Z', '20190510T0347Z', '20190510T0348Z', '20190510T0349Z', '20190510T0350Z', '20190510T0351Z', '20190510T0352Z', '20190510T0353Z', '20190510T0354Z', '20190510T0355Z', '20190510T0356Z', '20190510T0357Z', '20190510T0358Z', '20190510T0359Z', '20190510T0400Z', '20190510T0401Z', '20190510T0402Z', '20190510T0403Z', '20190510T0404Z', '20190510T0405Z', '20190510T0406Z', '20190510T0407Z', '20190510T0408Z', '20190510T0409Z', '20190510T0410Z', '20190510T0411Z', '20190510T0412Z', '20190510T0413Z', '20190510T0414Z', '20190510T0415Z', '20190510T0416Z', '20190510T0417Z', '20190510T0418Z', '20190510T0419Z', '20190510T0420Z', '20190510T0421Z', '20190510T0422Z', '20190510T0423Z', '20190510T0424Z', '20190510T0425Z', '20190510T0426Z', '20190510T0427Z', '20190510T0428Z', '20190510T0429Z', '20190510T0430Z', '20190510T0431Z', '20190510T0432Z', '20190510T0433Z', '20190510T0434Z', '20190510T0435Z', '20190510T0436Z', '20190510T0437Z', '20190510T0438Z', '20190510T0439Z', '20190510T0440Z', '20190510T0441Z', '20190510T0442Z', '20190510T0443Z', '20190510T0444Z', '20190510T0445Z', '20190510T0446Z', '20190510T0447Z', '20190510T0448Z', '20190510T0449Z', '20190510T0450Z', '20190510T0451Z', '20190510T0452Z', '20190510T0453Z', '20190510T0454Z', '20190510T0455Z', '20190510T0456Z', '20190510T0457Z', '20190510T0458Z', '20190510T0459Z', '20190510T0500Z', '20190510T0501Z', '20190510T0502Z', '20190510T0503Z', '20190510T0504Z', '20190510T0505Z', '20190510T0506Z', '20190510T0507Z', '20190510T0508Z', '20190510T0509Z', '20190510T0510Z', '20190510T0511Z', '20190510T0512Z', '20190510T0513Z', '20190510T0514Z', '20190510T0515Z', '20190510T0516Z', '20190510T0517Z', '20190510T0518Z', '20190510T0519Z', '20190510T0520Z', '20190510T0521Z', '20190510T0522Z', '20190510T0523Z', '20190510T0524Z', '20190510T0525Z', '20190510T0526Z', '20190510T0527Z', '20190510T0528Z', '20190510T0529Z', '20190510T0530Z', '20190510T0531Z', '20190510T0532Z', '20190510T0533Z', '20190510T0534Z', '20190510T0535Z', '20190510T0536Z', '20190510T0537Z', '20190510T0538Z', '20190510T0539Z', '20190510T0540Z', '20190510T0541Z', '20190510T0542Z', '20190510T0543Z', '20190510T0544Z', '20190510T0545Z', '20190510T0546Z', '20190510T0547Z', '20190510T0548Z', '20190510T0549Z', '20190510T0550Z', '20190510T0551Z', '20190510T0552Z', '20190510T0553Z', '20190510T0554Z', '20190510T0555Z', '20190510T0556Z', '20190510T0557Z', '20190510T0558Z', '20190510T0559Z', '20190510T0600Z', '20190510T0601Z', '20190510T0602Z', '20190510T0603Z', '20190510T0604Z', '20190510T0605Z', '20190510T0606Z', '20190510T0607Z', '20190510T0608Z', '20190510T0609Z', '20190510T0610Z', '20190510T0611Z', '20190510T0612Z', '20190510T0613Z', '20190510T0614Z', '20190510T0615Z', '20190510T0616Z', '20190510T0617Z', '20190510T0618Z', '20190510T0619Z', '20190510T0620Z', '20190510T0621Z', '20190510T0622Z', '20190510T0623Z', '20190510T0624Z', '20190510T0625Z', '20190510T0626Z', '20190510T0627Z', '20190510T0628Z', '20190510T0629Z', '20190510T0630Z', '20190510T0631Z', '20190510T0632Z', '20190510T0633Z', '20190510T0634Z', '20190510T0635Z', '20190510T0636Z', '20190510T0637Z', '20190510T0638Z', '20190510T0639Z', '20190510T0640Z', '20190510T0641Z', '20190510T0642Z', '20190510T0643Z', '20190510T0644Z', '20190510T0645Z', '20190510T0646Z', '20190510T0647Z', '20190510T0648Z', '20190510T0649Z', '20190510T0650Z', '20190510T0651Z', '20190510T0652Z', '20190510T0653Z', '20190510T0654Z', '20190510T0655Z', '20190510T0656Z', '20190510T0657Z', '20190510T0658Z', '20190510T0659Z', '20190510T0700Z', '20190510T0701Z', '20190510T0702Z', '20190510T0703Z', '20190510T0704Z', '20190510T0705Z', '20190510T0706Z', '20190510T0707Z', '20190510T0708Z', '20190510T0709Z', '20190510T0710Z', '20190510T0711Z', '20190510T0712Z', '20190510T0713Z', '20190510T0714Z', '20190510T0715Z', '20190510T0716Z', '20190510T0717Z', '20190510T0718Z', '20190510T0719Z', '20190510T0720Z', '20190510T0721Z', '20190510T0722Z', '20190510T0723Z', '20190510T0724Z', '20190510T0725Z', '20190510T0726Z', '20190510T0727Z', '20190510T0728Z', '20190510T0729Z', '20190510T0730Z', '20190510T0731Z', '20190510T0732Z', '20190510T0733Z', '20190510T0734Z', '20190510T0735Z', '20190510T0736Z', '20190510T0737Z', '20190510T0738Z', '20190510T0739Z', '20190510T0740Z', '20190510T0741Z', '20190510T0742Z', '20190510T0743Z', '20190510T0744Z', '20190510T0745Z', '20190510T0746Z', '20190510T0747Z', '20190510T0748Z', '20190510T0749Z', '20190510T0750Z', '20190510T0751Z', '20190510T0752Z', '20190510T0753Z', '20190510T0754Z', '20190510T0755Z', '20190510T0756Z', '20190510T0757Z', '20190510T0758Z', '20190510T0759Z', '20190510T0800Z', '20190510T0801Z', '20190510T0802Z', '20190510T0803Z', '20190510T0804Z', '20190510T0805Z', '20190510T0806Z', '20190510T0807Z', '20190510T0808Z', '20190510T0809Z', '20190510T0810Z', '20190510T0811Z', '20190510T0812Z', '20190510T0813Z', '20190510T0814Z', '20190510T0815Z', '20190510T0816Z', '20190510T0817Z', '20190510T0818Z', '20190510T0819Z', '20190510T0820Z', '20190510T0821Z', '20190510T0822Z', '20190510T0823Z', '20190510T0824Z', '20190510T0825Z', '20190510T0826Z', '20190510T0827Z', '20190510T0828Z', '20190510T0829Z', '20190510T0830Z', '20190510T0831Z', '20190510T0832Z', '20190510T0833Z', '20190510T0834Z', '20190510T0835Z', '20190510T0836Z', '20190510T0837Z', '20190510T0838Z', '20190510T0839Z', '20190510T0840Z', '20190510T0841Z', '20190510T0842Z', '20190510T0843Z', '20190510T0844Z', '20190510T0845Z', '20190510T0846Z', '20190510T0847Z', '20190510T0848Z', '20190510T0849Z', '20190510T0850Z', '20190510T0851Z', '20190510T0852Z', '20190510T0853Z', '20190510T0854Z', '20190510T0855Z', '20190510T0856Z', '20190510T0857Z', '20190510T0858Z', '20190510T0859Z', '20190510T0900Z', '20190510T0901Z', '20190510T0902Z', '20190510T0903Z', '20190510T0904Z', '20190510T0905Z', '20190510T0906Z', '20190510T0907Z', '20190510T0908Z', '20190510T0909Z', '20190510T0910Z', '20190510T0911Z', '20190510T0912Z', '20190510T0913Z', '20190510T0914Z', '20190510T0915Z', '20190510T0916Z', '20190510T0917Z', '20190510T0918Z', '20190510T0919Z', '20190510T0920Z', '20190510T0921Z', '20190510T0922Z', '20190510T0923Z', '20190510T0924Z', '20190510T0925Z', '20190510T0926Z', '20190510T0927Z', '20190510T0928Z', '20190510T0929Z', '20190510T0930Z', '20190510T0931Z', '20190510T0932Z', '20190510T0933Z', '20190510T0934Z', '20190510T0935Z', '20190510T0936Z', '20190510T0937Z', '20190510T0938Z', '20190510T0939Z', '20190510T0940Z', '20190510T0941Z', '20190510T0942Z', '20190510T0943Z', '20190510T0944Z', '20190510T0945Z', '20190510T0946Z', '20190510T0947Z', '20190510T0948Z', '20190510T0949Z', '20190510T0950Z', '20190510T0951Z', '20190510T0952Z', '20190510T0953Z', '20190510T0954Z', '20190510T0955Z', '20190510T0956Z', '20190510T0957Z', '20190510T0958Z', '20190510T0959Z', '20190510T1000Z']}


def parse_feed(**context):
    feed_id = context['params']['feed_id']
    ts_f_strings = context['params']['ts_f_strings']
    parse_errors = []

    filenames = [f'raw/{feed_id}/{ts_f_string}.pb' for ts_f_string in ts_f_strings]

    # we could process everything in one go, but memory usage would be extremely high
    # gtfs_tripify defines a merge operation, which we take advantage of with batching
    chunk_size = 60 * 4  # up to 4hrs
    segments = []
    for chunk_idx in range(0, len(filenames), chunk_size):
        filenames_slice = filenames[chunk_idx:chunk_idx + chunk_size]
        stream = []

        for filename in filenames_slice:
            try:
                update = aws_client.get_object(Bucket=AWS_BUCKET_NAME, Key=filename)['Body']
                stream.append(update.read())
            except aws_client.exceptions.NoSuchKey:
                # not all updates are actually written; there may be issues either with the
                # DAG scheduler or issues downstream with the data provider
                parse_errors.append({
                    'type': 'feed_update_file_not_available',
                    'details': {
                        'update_filepath': filename,
                        'update_timestamp': time_iterator.timestamp()
                    }
                })

        logbook, timestamps, new_parse_errors = gt.logify(stream)
        parse_errors += new_parse_errors
        segments.append((logbook, timestamps))

    logbook, timestamps = gt.ops.merge_logbooks(segments)
    logbook = gt.ops.cut_cancellations(logbook)
    logbook = gt.ops.discard_partial_logs(logbook)
    logbooks, _ = gt.ops.partition_on_route_id(logbook, timestamps)

    for route_id in logbooks:
        if route_id not in ROUTE_IDS:
            parse_errors.append({
                'type': 'feed_update_included_unknown_route_id',
                'details': {'route_id': route_id}
            })
            continue

        gt.ops.to_csv(logbooks[route_id], f'stop_times_{route_id}.csv')
        aws_client.upload_file(
            Filename=f'stop_times_{route_id}.csv',
            Bucket=AWS_BUCKET_NAME,
            Key=f'rollups/{rollup_start_time}/{route_id}/stop_times.csv'
        )

    for route_id in logbooks:
        os.remove(f'stop_times_{route_id}.csv')

    with open('parse_errors.json', 'w') as fp:
        json.dump(parse_errors, fp, indent=4)
    aws_client.upload_file(
        Filename='parse_errors.json',
        Bucket=AWS_BUCKET_NAME,
        Key=f'rollup_logs/{rollup_start_time}/parse_errors.json'
    )
    os.remove('parse_errors.json')


parse_feed(params=params)
